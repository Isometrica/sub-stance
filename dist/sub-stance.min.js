/*! sub-stance 2015-Sep-24 */
"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="ui.router"),function(a,b,c){function d(a,b){function c(a,b){return _.map(a,function(a){if(_.isObject(a)){var c=_.extend({},a);return c.args=_.map(a.args,function(a){return b[a]}),c}return a})}function d(a){return[].concat.apply([],_.pluck(_.filter(a,_.isObject),"args"))}function e(a,b){if(a.parent&&a.parent.data){var c=a.parent.data;c.$subs&&(a.data||(a.data={}),a.data.$subs?a.data.$subs=c.$subs.concat(a.data.$subs):a.data.$subs=c.$subs)}return b(a)}function f(a,b,e){function f(b,c){var f=d(b);_.each(f,function(b){if(_.isUndefined(c[b])){var d=a.params[b];d?c[b]=d:e.warn("State param "+b+" doesn't exist but $subs requires it.")}})}var g=a.transitionTo;return a.transitionTo=function(d,e,h){var i,j=Array.prototype.slice.call(arguments),k=a.get(d).data;if(k){var l=k.$subs;f(l,e),i=c(l,e)}return b.transition(i).then(function(){return g.apply(a,j)})},a}f.$inject=["$delegate","$subs","$log"],b.decorator("$state",f),a.decorator("data",e)}function e(a,b,c,d){function e(a){return _.uniq(a,function(a){return a.hashKey})}function f(a){return e(_.map(a,function(a){var b;return b=_.isObject(a)?[a.name].concat(a.args):[a],{hashKey:b.join(","),args:b}}))}return{_currentSubs:{},_transQ:b.when(!0),_discardQs:{},_discardSub:function(a){var b=this;b._discardQs[a]||(b._discardQs[a]=d(function(){var c=b._currentSubs[a];c&&(c.stop(),delete b._currentSubs[a]),b._cleanUpDiscQ(a)},1e4))},_cleanUpDiscQ:function(a){delete this._discardQs[a]},_invalidateDiscardQ:function(a){var b=this._discardQs[a];b&&(d.cancel(b),this._cleanUpDiscQ(a))},transition:function(a){var d=this,e=f(a);return d._transQ=d._transQ.then(function(){var a=d._migrate(e);return b.all(_.map(a,function(a){return d._invokeSub(a).then(function(a){a.$$stateReq=!0})}))})["catch"](function(a){c.$broadcast("$subTransitionError",a)}),d._transQ},createDescriptorFor:function(a,b){var c=this;return _.isUndefined(b.$$retainCount)?b.$$retainCount=1:++b.$$retainCount,{_dead:!1,stop:function(){if(this._dead)throw new Error("Descriptor already dead.");this._dead=!0,--b.$$retainCount,b.$$stateReq||b.$$retainCount||c._discardSub(a)}}},need:function(){var a=Array.prototype.slice.call(arguments),c={hashKey:a.join(","),args:a},d=this,e=d._currentSubs[c.hashKey];return e?b.resolve(d.createDescriptorFor(c.hashKey,e)):(d._transQ=d._transQ.then(function(){return d._invokeSub(c).then(function(a){return d.createDescriptorFor(c.hashKey,a)})}),d._transQ)},needBind:function(a){return this.need.apply(this,Array.prototype.slice.call(arguments,1)).then(function(b){return a.$on("$destroy",function(){b.stop()}),b})},_invokeSub:function(b){var c=this;return a.subscribe.apply(a,b.args).then(function(a){return c._currentSubs[b.hashKey]=a,a})},_migrate:function(a){var b=this,c=_.filter(a,function(a){return!(b._currentSubs[a.hashKey]||b._discardQs[a.hashKey])});return _.each(b._currentSubs,function(c,d){var e=function(a){return a.hashKey===d},f=c.$$retainCount||_.some(a,e),g=b._discardQs[d];f&&g?b._invalidateDiscardQ(d):f||g||b._discardSub(d)}),c}}}b.module("isa.substance",["angular-meteor","ui.router"]),b.module("isa.substance").config(d),d.$inject=["$stateProvider","$provide"],b.module("isa.substance").service("$subs",e),e.$inject=["$meteor","$q","$rootScope","$timeout"]}(window,window.angular);