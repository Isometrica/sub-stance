/*! sub-stance 2015-Oct-06 */
"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="isa.substance"),function(a,b,c){function d(a,c){function d(a,b){return _.map(a,function(a){if(_.isObject(a)){var c=_.extend({},a);return c.args=_.map(a.args,function(a){return b[a]}),c}return a})}function e(a){return[].concat.apply([],_.pluck(_.filter(a,_.isObject),"args"))}function f(a,b){if(a.parent&&a.parent.data){var c=a.parent.data;c.$subs&&(a.data||(a.data={}),a.data.$subs?a.data.$subs=c.$subs.concat(a.data.$subs):a.data.$subs=c.$subs)}return b(a)}function g(a,c,f,g){function h(c,d){var g=e(c),h=b.extend({},d)||{};return _.map(g,function(b){if(_.isUndefined(h[b])){var c=a.params[b];c?h[b]=c:f.warn("State param "+b+" doesn't exist but $subs requires it.")}}),h}var i=a.transitionTo;return a.transitionTo=function(b,e,f){var j,k=Array.prototype.slice.call(arguments),l=a.get(b,f?f.relative:null);if(l&&l.data){var m=l.data.$subs,n=h(m,e);j=d(m,n)}return g.$broadcast("$subTransitionStart",l,e),c.transition(j).then(function(){return i.apply(a,k)},function(a){g.$broadcast("$subTransitionError",l,e,a)})},a}g.$inject=["$delegate","$subs","$log","$rootScope"],c.decorator("$state",g),a.decorator("data",f)}function e(a,b,c,d,e){function f(a){return _.uniq(a,function(a){return a.hashKey})}function g(a){var b;return b=_.isArray(a)?a:_.isObject(a)?[a.name].concat(a.args):[a],{hashKey:b.join(","),args:b}}function h(a){return f(_.map(a,g))}return{_currentSubs:{},_opsQ:b.when(!0),_pushOp:function(a,b){return this._opsQ=this._opsQ.then(a)["catch"](b),this._opsQ},_discQs:{},_discard:function(a){e.debug("-- Posting discard for "+a);var b=this;b._discarding(a)||(e.debug("-- Can discard"),b._discQs[a]=d(function(){e.debug("--- Discarding "+a),b._stop(a)._purgeDisc(a)},1e4))},_stop:function(a){var b=this._currentSubs[a];return b&&(b.stop(),delete this._currentSubs[a]),this},_discarding:function(a){return this._discQs[a]},_purgeDisc:function(a){delete this._discQs[a]},_ensureKeep:function(a){e.debug("-- Ensure "+a+" is kept.");var b=this._discarding(a);b&&(e.debug("-- Saved from delete!"),d.cancel(b),this._purgeDisc(a))},_clearAll:function(){var a=this;_.each(a._currentSubs,function(b,c){a._stop(c)})},transition:function(a){var b=this,c=h(a);return e.debug("- Transitioning to ",_.map(c,function(a){return a.hashKey})),b._pushOp(function(){return b._migrate(c)},function(){b._clearAll()})},_createDescriptor:function(a,b){var c=this;return _.isUndefined(b.$$retainCount)?b.$$retainCount=1:++b.$$retainCount,{_dead:!1,stop:function(){if(this._dead)throw new Error("Descriptor already dead.");this._dead=!0,--b.$$retainCount,e.debug("- Stopping descriptor "+a),b.$$stateReq||b.$$retainCount||(e.debug("- Actually discarding this sub now"),c._discard(a))}}},need:function(){var a=Array.prototype.slice.call(arguments),c=g(a),d=this;return d._pushOp(function(){var a=d._currentSubs[c.hashKey];if(a){d._ensureKeep(c.hashKey);var e=d._createDescriptor(c.hashKey,a);return b.resolve(e)}return d._invokeSub(c).then(function(a){return d._createDescriptor(c.hashKey,a)})})},needBind:function(a){return this.need.apply(this,Array.prototype.slice.call(arguments,1)).then(function(b){return a.$on("$destroy",function(){b.stop()}),b})},_invokeSub:function(b){var c=this;return a.subscribe.apply(a,b.args).then(function(a){return c._currentSubs[b.hashKey]=a,a})},_migrate:function(a){var c=this,d=_.filter(a,function(a){return!c._currentSubs[a.hashKey]});_.each(c._currentSubs,function(b,d){var e=function(a){return a.hashKey===d},f=_.some(a,e);f?c._ensureKeep(d):b.$$retainCount||c._discard(d),b.$$stateReq=f});var e=_.map(d,function(a){return c._invokeSub(a).then(function(a){a.$$stateReq=!0})});return b.all(e)}}}b.module("isa.substance",["angular-meteor","ui.router"]),b.module("isa.substance").config(d),d.$inject=["$stateProvider","$provide"],b.module("isa.substance").service("$subs",e),e.$inject=["$meteor","$q","$rootScope","$timeout","$log"]}(window,window.angular);